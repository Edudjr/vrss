<!DOCTYPE>
<html>
	<head>
		<script type="text/javascript" src="/js/jquery.min.js"></script>
		<script type="text/javascript" src="/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="/js/bootstrap.js"></script>
		
		<link href="/css/default.css" rel="stylesheet">
		<link href="/css/bootstrap.min.css" rel="stylesheet">
		<link href="/css/bootstrap-theme.min.css" rel="stylesheet">
		<link href="/css/bootstrap.css" rel="stylesheet">
		

	</head>
	<body>
		<div id="wrap">
			<div class="container">
				<div class="row clearfix">
					<div class="col-md-12 column" style="margin-top: 30px">
						<h1>Rss Model</h1>
						<div class="jumbotron">
								<p>This <strong>RSS reader</strong> is running on the <strong>server side</strong> using <strong>superfeedr</strong>.<br>
								The content from this page and the other one not always updates at the same time, AND I DONT NOW WHY.
								You <strong>DON'T</strong> need to reload the page to get new content. 
								It will be refreshed every 10 seconds. If you wanna go <strong>faster</strong>, click on <strong>LOAD</strong>.</p>
								<a id="load"  class="btn btn-primary btn-lg">
									Load <img id="loading" src="/images/ajax-loader.gif" style="height:20px; display:none"></img>
								</a>
								<a href="/" style="float:right" class="btn btn-primary btn-lg">Back</a>
							</div>
						
						<div id="start">
							<!-- ITEMS-->
							
						</div>
						
					</div>
				</div>
			</div>
		</div>
	</body>
<script>
	
	//if user clicks on load button, call load function
	$('#load').click(load);
	
	//call laod function every 8 seconds
	setInterval('load()', 8000);
	
	$.post( "/live", function(data){
		//get data from /live and then pass it to firstrun function
		firstrun(data);
	});
	
	function firstrun(data){
		$.each(data.items, function (i, e) {
			var str = e.content;
			var content = String(str).replace(/<img.*>/i,"");
			var img = str.match(/<img.*>/i);
			var img_resized = String(img).replace(">", "style=\"width: 300px;\">");
			var footer = str.match(/<a href.*?>Continue.*?<\/a>/i);
			content = String(content).replace(/<a href.*?>Continue.*?<\/a>/i, "");
			//console.log("Match found: " + footer);

			//console.log("found: "+str);

			//console.log("------------------------");
			//console.log("title      : " + e.title);
			//console.log("author     : " + e.author);
			//console.log("description: " + e.content);
			//$('#start').append("<br>---------------------------<h3>"+e.title+"</h3><br><p>"+e.content+"</p>");
			$('#start').append("<div id=\"item\" class=\"panel panel-default\">"
											+"<div id=\"panelwrapper\" class=\"panel-body\">"
												+"<div id=\"title\">"
													+"<h3>"+e.title+"</h3><br>"
												+"</div>"
												+"<div id=\"image\" class=\"img-thumbnail\">"
													+img_resized
												+"</div>"
												+"<div id=\"content\">"
													+content
												+"</div>"
												+"<div id=\"item_footer\">"
													+footer
												+"</div>"
											+"</div>"
										+"</div>"
			);
		})
	}
	
		//This function will play the loading gif for 1 second and then call the verify_news function
	function load(){
		$("#loading").show(200);
		setTimeout('verify_news()', 1000);
	}
	
	//makes an AJAX call and get the new content, if available
	function verify_news(){
		$.ajax({
			url: "/load",
			type: "GET",
			cache: false,
			success: function(data, status, xhr){
				//hides loading gif when done
				$("#loading").hide(200);
				//if content didn't change, return
				if(xhr.status==304)
					return console.log("no news");
				else
					console.log("Changing content");
				
				var str = data.content;
				var regex = /<img.*>/i; //regex for retrieving image element from data.content
				var content = String(str).replace(/<img.*>/i,""); //get rid of image element in content
				var img = str.match(regex);//retrieving image element from data.content
				var img_resized = String(img).replace(">", "style=\"width: 300px;\">");//resizes image to fit my div
				var continue_reading = new RegExp(/<a href.*?>Continue.*?<\/a>/i);//regex for retrieving link to "continue reading"
				continue_reading.test(str);
				var footer = RegExp.lastMatch;
				
				$('#start').prepend("<div id=\"item\" class=\"panel panel-default\">"
												+"<div id=\"panelwrapper\" class=\"panel-body\">"
													+"<div id=\"title\">"
														+"<h3>"+data.title+"</h3><br>"
													+"</div>"
													+"<div id=\"image\" class=\"img-thumbnail\">"
														+img_resized
													+"</div>"
													+"<div id=\"content\">"
														+content
													+"</div>"
													+"<div id=\"item_footer\">"
														+footer
													+"</div>"
												+"</div>"
											+"</div>"
				);
				$("#item:last-child").remove();
			}
		});
	}

</script>
</html>